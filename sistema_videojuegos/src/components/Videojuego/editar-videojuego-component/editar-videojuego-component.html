<app-header-admin-empresa></app-header-admin-empresa>

<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <!-- Header -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h1 class="h2 mb-0">
                <i class="bi bi-pencil-square me-2 text-primary"></i>
                Editar Videojuego
                @if (videojuegoId) {
                  <span class="text-muted">#{{ videojuegoId }}</span>
                }
              </h1>
              <p class="text-muted mb-0">Modifica la información del videojuego</p>
            </div>
            <button class="btn btn-outline-secondary" (click)="volver()">
              <i class="bi bi-arrow-left me-1"></i>
              Volver
            </button>
          </div>
        </div>
      </div>

      <!-- Loading del videojuego -->
      @if (isLoadingVideojuego) {
        <div class="row">
          <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3 text-muted">Cargando videojuego...</p>
          </div>
        </div>
      }

      <!-- Contenido principal -->
      @if (!isLoadingVideojuego) {
        <!-- Mensajes -->
        @if (errorMessage) {
          <div class="row mb-3">
            <div class="col-12">
              <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                {{ errorMessage }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            </div>
          </div>
        }

        @if (successMessage) {
          <div class="row mb-3">
            <div class="col-12">
              <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle-fill me-2"></i>
                {{ successMessage }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            </div>
          </div>
        }

        <!-- Formulario -->
        <form [formGroup]="videojuegoForm" (ngSubmit)="onSubmit()" novalidate>
          <!-- Información Básica -->
          <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">
                <i class="bi bi-info-circle me-2"></i>
                Información Básica
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                <!-- Título -->
                <div class="col-md-6 mb-3">
                  <label for="titulo" class="form-label">
                    Título <span class="text-danger">*</span>
                  </label>
                  <input
                    type="text"
                    id="titulo"
                    formControlName="titulo"
                    class="form-control"
                    [class.is-invalid]="f['titulo'].invalid && f['titulo'].touched"
                    placeholder="Ej: Super Mario Bros"
                  >
                  @if (f['titulo'].invalid && f['titulo'].touched) {
                    <div class="invalid-feedback">
                      @if (f['titulo'].errors?.['required']) {
                        <div>El título es requerido</div>
                      }
                      @if (f['titulo'].errors?.['minlength']) {
                        <div>Mínimo 3 caracteres</div>
                      }
                      @if (f['titulo'].errors?.['maxlength']) {
                        <div>Máximo 100 caracteres</div>
                      }
                    </div>
                  }
                </div>

                <!-- Precio -->
                <div class="col-md-6 mb-3">
                  <label for="precio" class="form-label">
                    Precio (Q) <span class="text-danger">*</span>
                  </label>
                  <div class="input-group">
                    <span class="input-group-text">Q</span>
                    <input
                      type="number"
                      id="precio"
                      formControlName="precio"
                      class="form-control"
                      [class.is-invalid]="f['precio'].invalid && f['precio'].touched"
                      step="0.01"
                      min="0"
                      placeholder="0.00"
                    >
                  </div>
                  @if (f['precio'].invalid && f['precio'].touched) {
                    <div class="invalid-feedback">
                      @if (f['precio'].errors?.['required']) {
                        <div>El precio es requerido</div>
                      }
                      @if (f['precio'].errors?.['min']) {
                        <div>El precio debe ser mayor o igual a 0</div>
                      }
                    </div>
                  }
                </div>

                <!-- Fecha de Lanzamiento -->
                <div class="col-md-6 mb-3">
                  <label for="fecha_lanzamiento" class="form-label">
                    Fecha de Lanzamiento <span class="text-danger">*</span>
                  </label>
                  <input
                    type="date"
                    id="fecha_lanzamiento"
                    formControlName="fecha_lanzamiento"
                    class="form-control"
                    [class.is-invalid]="f['fecha_lanzamiento'].invalid && f['fecha_lanzamiento'].touched"
                  >
                  @if (f['fecha_lanzamiento'].invalid && f['fecha_lanzamiento'].touched) {
                    <div class="invalid-feedback">
                      La fecha de lanzamiento es requerida
                    </div>
                  }
                </div>

                <!-- Clasificación de Edad -->
                <div class="col-md-6 mb-3">
                  <label for="clasificacion_edad" class="form-label">
                    Clasificación de Edad <span class="text-danger">*</span>
                  </label>
                  <select
                    id="clasificacion_edad"
                    formControlName="clasificacion_edad"
                    class="form-select"
                    [class.is-invalid]="f['clasificacion_edad'].invalid && f['clasificacion_edad'].touched"
                  >
                    <option value="E">E - Everyone (Para todos)</option>
                    <option value="T">T - Teen (Adolescentes)</option>
                    <option value="M">M - Mature (Maduro 17+)</option>
                    <option value="AO">AO - Adults Only (Solo adultos)</option>
                    <option value="RP">RP - Rating Pending (Pendiente)</option>
                  </select>
                  @if (f['clasificacion_edad'].invalid && f['clasificacion_edad'].touched) {
                    <div class="invalid-feedback">
                      La clasificación de edad es requerida
                    </div>
                  }
                </div>

                <!-- Descripción -->
                <div class="col-12 mb-3">
                  <label for="descripcion" class="form-label">
                    Descripción <span class="text-danger">*</span>
                  </label>
                  <textarea
                    id="descripcion"
                    formControlName="descripcion"
                    class="form-control"
                    [class.is-invalid]="f['descripcion'].invalid && f['descripcion'].touched"
                    rows="4"
                    placeholder="Describe el videojuego..."
                  ></textarea>
                  @if (f['descripcion'].invalid && f['descripcion'].touched) {
                    <div class="invalid-feedback">
                      @if (f['descripcion'].errors?.['required']) {
                        <div>La descripción es requerida</div>
                      }
                      @if (f['descripcion'].errors?.['minlength']) {
                        <div>Mínimo 10 caracteres</div>
                      }
                    </div>
                  }
                </div>

                <!-- Recursos Mínimos -->
                <div class="col-12 mb-3">
                  <label for="recursos_minimos" class="form-label">
                    Recursos Mínimos <span class="text-danger">*</span>
                  </label>
                  <textarea
                    id="recursos_minimos"
                    formControlName="recursos_minimos"
                    class="form-control"
                    [class.is-invalid]="f['recursos_minimos'].invalid && f['recursos_minimos'].touched"
                    rows="3"
                    placeholder="Ej: Procesador: Intel i5, RAM: 8GB, Gráficos: GTX 1060..."
                  ></textarea>
                  @if (f['recursos_minimos'].invalid && f['recursos_minimos'].touched) {
                    <div class="invalid-feedback">
                      Los recursos mínimos son requeridos
                    </div>
                  }
                </div>

                <!-- Comentarios Bloqueados -->
                <div class="col-12 mb-3">
                  <div class="form-check">
                    <input
                      type="checkbox"
                      id="comentarios_bloqueados"
                      formControlName="comentarios_bloqueados"
                      class="form-check-input"
                    >
                    <label for="comentarios_bloqueados" class="form-check-label">
                      Bloquear comentarios
                    </label>
                    <small class="form-text text-muted d-block">
                      Si activas esta opción, los usuarios no podrán comentar en este videojuego
                    </small>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Categorías -->
          <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">
                <i class="bi bi-tags me-2"></i>
                Categorías
              </h5>
            </div>
            <div class="card-body">
              <!-- Lista de categorías seleccionadas -->
              @if (videojuegoForm.get('categorias_ids')?.value?.length > 0) {
                <div class="mb-3">
                  <h6 class="mb-2">Categorías actuales:</h6>
                  <div class="d-flex flex-wrap gap-2 mb-3">
                    @for (catId of videojuegoForm.get('categorias_ids')?.value; track catId) {
                      <span class="badge bg-primary py-2 px-3">
                        {{ getNombreCategoria(catId) }}
                        <button type="button" 
                                class="btn-close btn-close-white ms-2" 
                                style="font-size: 0.6rem;"
                                (click)="toggleCategoria(catId); $event.stopPropagation()"
                                aria-label="Remover"></button>
                      </span>
                    }
                  </div>
                </div>
              }

              <!-- Loading de categorías -->
              @if (isLoadingCategorias) {
                <div class="text-center py-3">
                  <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                  </div>
                  <span class="ms-2">Cargando categorías...</span>
                </div>
              }

              <!-- Grid de categorías disponibles -->
              @if (!isLoadingCategorias && categorias.length > 0) {
                <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
                  @for (categoria of categorias; track categoria.id_categoria) {
                    <div class="col">
                      <div class="form-check p-3 border rounded hover-card"
                           [class.border-primary]="isCategoriaSelected(categoria.id_categoria)"
                           (click)="toggleCategoria(categoria.id_categoria)">
                        <input type="checkbox"
                               [id]="'categoria-' + categoria.id_categoria"
                               class="form-check-input me-2"
                               [checked]="isCategoriaSelected(categoria.id_categoria)">
                        <label [for]="'categoria-' + categoria.id_categoria" 
                               class="form-check-label w-100">
                          <div class="fw-bold">{{ categoria.nombre }}</div>
                        </label>
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          </div>

          <!-- Imágenes Existentes -->
          <div class="card shadow-sm mb-4">
            <div class="card-header bg-danger text-white">
              <h5 class="mb-0">
                <i class="bi bi-images me-2"></i>
                Imágenes Actuales
                <span class="badge bg-light text-dark ms-2">
                  {{ imagenesExistentes.length }}
                </span>
              </h5>
            </div>
            <div class="card-body">
              @if (imagenesExistentes.length > 0) {
                <div class="mb-3">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                      <small class="text-muted">
                        Puedes eliminar imágenes individualmente
                      </small>
                    </div>
                    <button type="button" 
                            class="btn btn-sm btn-outline-danger"
                            (click)="eliminarTodasLasImagenes()">
                      <i class="bi bi-trash me-1"></i>
                      Eliminar Todas
                    </button>
                  </div>

                  <div class="row">
                    @for (imagen of imagenesExistentes; track imagen.id_multimedia) {
                      <div class="col-md-3 mb-3">
                        <div class="card">
                          <div class="card-body p-2 text-center">
                            <img [src]="getImagenUrl(imagen.imagenBase64)" 
                                 class="img-fluid rounded mb-2" 
                                 style="height: 100px; object-fit: cover;"
                                 [alt]="'Imagen ' + imagen.id_multimedia">
                            <p class="small text-truncate mb-1">Imagen #{{ imagen.id_multimedia }}</p>
                            <button type="button" 
                                    class="btn btn-sm btn-outline-danger"
                                    (click)="eliminarImagenExistente(imagen.id_multimedia)">
                              <i class="bi bi-trash"></i> Eliminar
                            </button>
                          </div>
                        </div>
                      </div>
                    }
                  </div>
                </div>
              } @else {
                <div class="alert alert-info">
                  <i class="bi bi-info-circle me-2"></i>
                  Este videojuego no tiene imágenes actualmente.
                </div>
              }
            </div>
          </div>

          <!-- Nuevas Imágenes -->
          <div class="card shadow-sm mb-4">
            <div class="card-header bg-success text-white">
              <h5 class="mb-0">
                <i class="bi bi-plus-circle me-2"></i>
                Agregar Nuevas Imágenes
                <span class="badge bg-light text-dark ms-2">
                  {{ nuevasImagenesBase64.length }} / {{ maxImagenes - imagenesExistentes.length }}
                </span>
              </h5>
            </div>
            <div class="card-body">
              <div class="mb-4">
                <label class="form-label">Seleccionar Nuevas Imágenes</label>
                <div class="input-group">
                  <input type="file"
                         class="form-control"
                         (change)="onFileSelected($event)"
                         accept="image/*"
                         multiple>
                </div>
                <small class="form-text text-muted">
                  Puedes agregar hasta {{ maxImagenes - imagenesExistentes.length }} imágenes nuevas.
                </small>
              </div>

              @if (nuevasImagenesBase64.length > 0) {
                <div class="row">
                  @for (imagen of nuevasImagenesBase64; track $index) {
                    <div class="col-md-3 mb-3">
                      <div class="card">
                        <div class="card-body p-2 text-center">
                          <img [src]="'data:image/jpeg;base64,' + imagen" 
                               class="img-fluid rounded mb-2" 
                               style="height: 100px; object-fit: cover;"
                               [alt]="'Nueva imagen ' + ($index + 1)">
                          <p class="small text-truncate mb-1">{{ getFileName($index) }}</p>
                          <button type="button" 
                                  class="btn btn-sm btn-outline-danger"
                                  (click)="eliminarNuevaImagen($index)">
                            <i class="bi bi-trash"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          </div>

          <!-- Botones de acción -->
          <div class="row">
            <div class="col-12">
              <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-outline-secondary" (click)="volver()">
                  <i class="bi bi-x-circle me-1"></i>
                  Cancelar
                </button>
                <div class="d-flex gap-2">
                  <button type="button" 
                          class="btn btn-outline-danger" 
                          >
                    <i class="bi bi-trash me-1"></i>
                    Eliminar Videojuego
                  </button>
                  <button type="submit" 
                          class="btn btn-primary"
                          [disabled]="videojuegoForm.invalid || isLoading">
                    @if (isLoading) {
                      <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                      Actualizando...
                    } @else {
                      <i class="bi bi-check-circle me-1"></i>
                      Actualizar Videojuego
                    }
                  </button>
                </div>
              </div>
            </div>
          </div>
        </form>
      }
    </div>
  </div>
</div>

<app-footer></app-footer>