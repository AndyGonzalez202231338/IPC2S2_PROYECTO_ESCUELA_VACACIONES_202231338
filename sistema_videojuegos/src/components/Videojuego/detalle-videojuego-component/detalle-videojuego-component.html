<app-header></app-header>

<div class="container py-4">
  <!-- Botón de volver -->
  <div class="row mb-4">
    <div class="col-12">
      <button class="btn btn-outline-secondary" (click)="volverATienda()">
        <i class="bi bi-arrow-left me-1"></i>
        Volver a la Tienda
      </button>
    </div>
  </div>

  <!-- Loading -->
  @if (isLoading) {
    <div class="row">
      <div class="col-12 text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-3 text-muted">Cargando información del videojuego...</p>
      </div>
    </div>
  }

  <!-- Error -->
  @if (errorMessage) {
    <div class="row mb-3">
      <div class="col-12">
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          {{ errorMessage }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      </div>
    </div>
  }

  <!-- Contenido principal -->
  @if (!isLoading && videojuego) {
    <div class="row">
      <!-- Columna izquierda: Carrusel e información básica -->
      <div class="col-lg-8">
        <!-- Carrusel de imágenes -->
        <div class="card shadow-sm mb-4">
          <div class="card-body p-0">
            @if (isLoadingImagenes) {
              <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-3 text-muted">Cargando imágenes...</p>
              </div>
            } 
            
            @else if (tieneImagenes()) {
              <!-- Carrusel Bootstrap -->
              <div id="carruselVideojuego" class="carousel slide" data-bs-ride="carousel">
                <!-- Indicadores -->
                <div class="carousel-indicators">
                  @for (imagen of imagenes; track $index) {
                    <button type="button" 
                            [attr.data-bs-target]="'#carruselVideojuego'"
                            [attr.data-bs-slide-to]="$index"
                            [class.active]="$index === imagenActiva"
                            (click)="cambiarImagen($index)"></button>
                  }
                </div>
                
                <!-- Imágenes -->
                <div class="carousel-inner">
                  @for (imagen of imagenes; track $index) {
                    <div class="carousel-item" [class.active]="$index === imagenActiva">
                      <img [src]="getImagenUrl(imagen.imagenBase64)" 
                           class="d-block w-100 carrusel-imagen"
                           [alt]="'Imagen ' + ($index + 1) + ' de ' + videojuego.titulo">
                    </div>
                  }
                </div>
                
                <!-- Controles -->
                <button class="carousel-control-prev" 
                        type="button" 
                        [attr.data-bs-target]="'#carruselVideojuego'"
                        data-bs-slide="prev"
                        (click)="imagenAnterior()">
                  <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                  <span class="visually-hidden">Anterior</span>
                </button>
                <button class="carousel-control-next" 
                        type="button" 
                        [attr.data-bs-target]="'#carruselVideojuego'"
                        data-bs-slide="next"
                        (click)="imagenSiguiente()">
                  <span class="carousel-control-next-icon" aria-hidden="true"></span>
                  <span class="visually-hidden">Siguiente</span>
                </button>
                
                <!-- Controles personalizados -->
                <div class="position-absolute bottom-0 end-0 m-3">
                  <button class="btn btn-sm btn-light" (click)="toggleAutoPlay()">
                    @if (carruselAutoPlay) {
                      <i class="bi bi-pause"></i>
                    } @else {
                      <i class="bi bi-play"></i>
                    }
                  </button>
                </div>
              </div>
            } 
            
            @else {
              <!-- Placeholder si no hay imágenes -->
              <div class="text-center py-5 bg-dark text-light">
                <i class="bi bi-controller" style="font-size: 4rem;"></i>
                <p class="mt-3">No hay imágenes disponibles</p>
              </div>
            }
          </div>
          
          <!-- Miniaturas (opcional) -->
          @if (tieneImagenes() && imagenes.length > 1) {
            <div class="card-footer">
              <div class="d-flex flex-wrap gap-2 justify-content-center">
                @for (imagen of imagenes; track $index) {
                  <button class="btn btn-sm p-0 border" 
                          (click)="cambiarImagen($index)"
                          [class.border-primary]="$index === imagenActiva">
                    <img [src]="getImagenUrl(imagen.imagenBase64)" 
                         class="img-thumbnail" 
                         style="width: 60px; height: 60px; object-fit: cover;"
                         [alt]="'Miniatura ' + ($index + 1)">
                  </button>
                }
              </div>
            </div>
          }
        </div>

        <!-- Información básica del videojuego -->
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
              <i class="bi bi-info-circle me-2"></i>
              Información del Videojuego
            </h5>
          </div>
          <div class="card-body">
            <!-- Título y precio -->
            <div class="d-flex justify-content-between align-items-start mb-4">
              <div>
                <h2 class="mb-2">{{ videojuego.titulo }}</h2>
                @if (videojuego.comentarios_bloqueados) {
                  <span class="badge bg-danger">
                    <i class="bi bi-lock me-1"></i> Comentarios bloqueados
                  </span>
                }
              </div>
              <div class="text-end">
                <div class="display-5 fw-bold text-success">
                  {{ formatearPrecio(videojuego.precio) }}
                </div>
              </div>
            </div>

            <!-- Descripción -->
            <div class="mb-4">
              <h5>Descripción</h5>
              <p class="text-muted">{{ videojuego.descripcion || 'Sin descripción disponible' }}</p>
            </div>

            <!-- Detalles en grid -->
            <div class="row">
              <div class="col-md-6 mb-3">
                <h6><i class="bi bi-cpu me-1"></i> Requisitos mínimos</h6>
                <p class="text-muted">{{ videojuego.recursos_minimos || 'No especificado' }}</p>
              </div>
              <div class="col-md-6 mb-3">
                <h6><i class="bi bi-calendar-check me-1"></i> Fecha de lanzamiento</h6>
                <p class="text-muted">{{ formatearFecha(videojuego.fecha_lanzamiento) }}</p>
              </div>
              <div class="col-md-6 mb-3">
                <h6><i class="bi bi-people me-1"></i> Clasificación</h6>
                <p class="text-muted">{{ videojuego.clasificacion_edad || 'N/A' }}</p>
              </div>
              <div class="col-md-6 mb-3">
                <h6><i class="bi bi-building me-1"></i> Empresa</h6>
                @if (isLoadingEmpresa) {
                  <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                  </div>
                } @else if (empresa) {
                  <p class="text-muted">{{ empresa.nombre }}</p>
                } @else {
                  <p class="text-muted">No disponible</p>
                }
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Columna derecha: Categorías y acciones -->
      <div class="col-lg-4">
        <!-- Categorías -->
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0">
              <i class="bi bi-tags me-2"></i>
              Categorías
            </h5>
          </div>
          <div class="card-body">
            @if (isLoadingCategorias) {
              <div class="text-center py-3">
                <div class="spinner-border spinner-border-sm text-success" role="status">
                  <span class="visually-hidden">Cargando...</span>
                </div>
                <span class="ms-2">Cargando categorías...</span>
              </div>
            } 
            
            @else if (tieneCategorias()) {
              <div class="d-flex flex-wrap gap-2">
                @for (categoria of categorias; track categoria.id_categoria) {
                  <span class="badge bg-light text-dark border p-2">
                    <i class="bi bi-tag me-1"></i>
                    {{ categoria.nombre }}
                  </span>
                }
              </div>
            } 
            
            @else {
              <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                Este videojuego no tiene categorías asignadas.
              </div>
            }
          </div>
        </div>

        <!-- Información adicional -->
        <div class="card shadow-sm">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0">
              <i class="bi bi-card-checklist me-2"></i>
              Detalles Técnicos
            </h5>
          </div>
          <div class="card-body">
            <ul class="list-unstyled">
              <li class="mb-2">
                <i class="bi bi-check-circle text-success me-2"></i>
                <strong>ID:</strong> {{ videojuego.id_videojuego }}
              </li>
              <li class="mb-2">
                <i class="bi bi-check-circle text-success me-2"></i>
                <strong>Empresa ID:</strong> {{ videojuego.id_empresa }}
              </li>
              <li class="mb-2">
                <i class="bi bi-check-circle text-success me-2"></i>
                <strong>Imágenes:</strong> {{ imagenes.length }}
              </li>
              <li class="mb-2">
                <i class="bi bi-check-circle text-success me-2"></i>
                <strong>Categorías:</strong> {{ categorias.length }}
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- Si no hay videojuego -->
  @if (!isLoading && !videojuego) {
    <div class="row">
      <div class="col-12">
        <div class="card border-dashed">
          <div class="card-body text-center py-5">
            <i class="bi bi-exclamation-circle display-1 text-muted mb-3"></i>
            <h3 class="h4 text-muted mb-3">Videojuego no encontrado</h3>
            <p class="text-muted mb-4">El videojuego que buscas no existe o ha sido removido.</p>
            <button class="btn btn-primary" (click)="volverATienda()">
              <i class="bi bi-arrow-left me-1"></i>
              Volver a la Tienda
            </button>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- Sección de Calificaciones y Comentarios -->
@if (videojuego && mostrarCalificaciones) {
  <div class="row mt-5">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-warning text-white">
          <div class="d-flex justify-content-between align-items-center">
            <h4 class="mb-0">
              <i class="bi bi-stars me-2"></i>
              Calificaciones y Comentarios
            </h4>
            <span class="badge bg-light text-dark">
              <i class="bi bi-people me-1"></i>
              Opiniones de la comunidad
            </span>
          </div>
        </div>
        <div class="card-body">
          <!-- Componente de calificaciones y comentarios -->
          <!-- Componente de calificaciones y comentarios -->
<app-calificaciones-comentarios
    [videojuegoId]="videojuego.id_videojuego"
    [mostrarTitulo]="false">
</app-calificaciones-comentarios>
        </div>
        <div class="card-footer text-muted small">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <i class="bi bi-info-circle me-1"></i>
              Las calificaciones y comentarios son de usuarios que han jugado este videojuego.
            </div>
            @if (currentUser) {
              <button class="btn btn-sm btn-outline-primary" 
                      [routerLink]="['/biblioteca']"
                      *ngIf="!videojuego.comentarios_bloqueados">
                <i class="bi bi-star me-1"></i>
                Calificar desde mi biblioteca
              </button>
            }
          </div>
        </div>
      </div>
    </div>
  </div>
}
</div>

<app-footer></app-footer>