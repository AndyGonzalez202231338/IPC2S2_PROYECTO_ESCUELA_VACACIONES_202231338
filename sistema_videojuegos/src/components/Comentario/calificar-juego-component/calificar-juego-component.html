<div class="calificar-container">
  <!-- Mensajes -->
  @if (mensajeError) {
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <i class="bi bi-exclamation-triangle-fill me-2"></i>
      {{ mensajeError }}
      <button type="button" class="btn-close" (click)="mensajeError = ''"></button>
    </div>
  }

  @if (mensajeExito) {
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <i class="bi bi-check-circle-fill me-2"></i>
      {{ mensajeExito }}
      <button type="button" class="btn-close" (click)="mensajeExito = ''"></button>
    </div>
  }

  <!-- Calificación -->
  <div class="mb-4">
    <h5 class="mb-3">
      <i class="bi bi-star-fill text-warning me-2"></i>
      Calificar Juego: {{ tituloJuego }}
    </h5>

    @if (yaCalificado) {
      <div class="calificacion-existente">
        <p class="mb-1"><strong>Ya calificaste este juego:</strong></p>
        <div class="d-flex align-items-center">
          <div class="estrellas me-3">
            @for (estrella of estrellas; track estrella) {
              <span class="estrella {{estrella <= calificacionUsuario ? 'activa' : ''}}">
                ★
              </span>
            }
          </div>
          <span class="badge bg-info">{{ calificacionUsuario }}/5</span>
        </div>
        <small class="text-muted d-block mt-2">No puedes modificar tu calificación</small>
      </div>
    } @else {
      <div class="calificar-form">
        <p class="text-muted mb-3">¿Qué calificación le das a este juego? (1-5 estrellas)</p>
        
        <div class="estrellas-seleccion mb-3">
          @for (estrella of estrellas; track estrella) {
            <button type="button" 
                    class="estrella-btn {{estrella <= estrellaSeleccionada ? 'seleccionada' : ''}}"
                    (click)="seleccionarEstrella(estrella)"
                    title="{{estrella}} estrellas">
              ★
            </button>
          }
        </div>

        <div class="estrellas-texto mb-3">
          @switch (estrellaSeleccionada) {
            @case (0) { <span class="text-muted">Selecciona una calificación</span> }
            @case (1) { <span class="text-danger"><i class="bi bi-emoji-frown me-1"></i>Malo</span> }
            @case (2) { <span class="text-warning"><i class="bi bi-emoji-neutral me-1"></i>Regular</span> }
            @case (3) { <span class="text-info"><i class="bi bi-emoji-smile me-1"></i>Bueno</span> }
            @case (4) { <span class="text-primary"><i class="bi bi-emoji-laughing me-1"></i>Muy Bueno</span> }
            @case (5) { <span class="text-success"><i class="bi bi-emoji-heart-eyes me-1"></i>Excelente</span> }
          }
        </div>

        <button class="btn btn-warning" 
                [disabled]="estrellaSeleccionada === 0 || isLoading"
                (click)="enviarCalificacion()">
          @if (isLoading) {
            <span class="spinner-border spinner-border-sm me-1" role="status"></span>
            Enviando...
          } @else {
            <i class="bi bi-send me-1"></i>
            Enviar Calificación
          }
        </button>
      </div>
    }
  </div>

  <hr>

  <!-- Comentario -->
  <div>
    <h5 class="mb-3">
      <i class="bi bi-chat-left-text-fill text-info me-2"></i>
      Dejar Comentario
    </h5>

    @if (yaComentado) {
      <div class="comentario-existente">
        <p class="mb-1"><strong>Tu comentario:</strong></p>
        <div class="card bg-light">
          <div class="card-body">
            <p class="mb-0">{{ comentarioUsuario }}</p>
          </div>
        </div>
        <small class="text-muted d-block mt-2">Ya has comentado este juego</small>
      </div>
    } @else {
      <!-- Solo mostrar el formulario si está disponible -->
      @if (comentarioForm) {
        <div class="comentar-form">
          <div [formGroup]="comentarioForm">
            <div class="mb-3">
              <textarea class="form-control" 
                        formControlName="comentario" 
                        rows="4"
                        placeholder="Comparte tu experiencia con este juego. ¿Te gustó? ¿Qué destacarías? (mínimo 10 caracteres)..."
                        [class.is-invalid]="comentarioForm.get('comentario')?.invalid && 
                                           comentarioForm.get('comentario')?.touched">
              </textarea>
              
              @if (comentarioForm.get('comentario')?.invalid && 
                   comentarioForm.get('comentario')?.touched) {
                <div class="invalid-feedback">
                  @if (comentarioForm.get('comentario')?.errors?.['required']) {
                    El comentario es requerido
                  }
                  @if (comentarioForm.get('comentario')?.errors?.['minlength']) {
                    Mínimo 10 caracteres
                  }
                  @if (comentarioForm.get('comentario')?.errors?.['maxlength']) {
                    Máximo 500 caracteres
                  }
                </div>
              }
              
              <div class="form-text text-end" 
                   [class.text-danger]="caracteresRestantes < 20"
                   [class.text-warning]="caracteresRestantes >= 20 && caracteresRestantes < 50">
                {{ caracteresRestantes }} caracteres restantes
              </div>
            </div>
          </div>

          <div class="d-flex gap-2">
            <button class="btn btn-info" 
                    [disabled]="!comentarioForm.valid || isLoading"
                    (click)="enviarComentario()">
              @if (isLoading) {
                <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                Publicando...
              } @else {
                <i class="bi bi-send me-1"></i>
                Publicar Comentario
              }
            </button>
            
            <button class="btn btn-outline-secondary" (click)="onCancelar()">
              <i class="bi bi-x-circle me-1"></i>
              Cancelar
            </button>
          </div>
        </div>
      } @else {
        <div class="alert alert-warning">
          <i class="bi bi-exclamation-triangle me-2"></i>
          Formulario de comentario no disponible
        </div>
      }
    }
  </div>

  <!-- Botones adicionales -->
  <div class="mt-4 pt-3 border-top">
    <div class="d-flex justify-content-between">
      <button class="btn btn-outline-primary btn-sm" (click)="verificarEstadoUsuario()">
        <i class="bi bi-arrow-clockwise me-1"></i>
        Recargar
      </button>
      <button class="btn btn-outline-dark btn-sm" (click)="onCancelar()">
        <i class="bi bi-box-arrow-left me-1"></i>
        Volver a la biblioteca
      </button>
    </div>
  </div>
</div>